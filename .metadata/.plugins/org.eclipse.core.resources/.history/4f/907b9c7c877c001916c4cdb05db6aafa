
import org.virtualbox_6_0.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.swing.plaf.ProgressBarUI;

public class MachinesManager {
	
	GlobalMaps maps=GlobalMaps.GetMaps();
	static int nameVM=0;//משתנה לשם חדש למכונה
	
	public VirtualBoxManager virtualBoxManager;
	public IVirtualBox vbox;
	public List<IMachine> machines;


public static void main(String[] args) {
		
		MachinesManager manager= new MachinesManager();	
	}

	
	//אמור להתבצע פעם אחת
	public  MachinesManager() {
	
	virtualBoxManager = VirtualBoxManager.createInstance(null);
	virtualBoxManager.connect("http://localhost:18083", "", "");
	
	 vbox = virtualBoxManager.getVBox();

	//רשימת המכונות הקיימות
	machines= vbox.getMachines();
	
	for (IMachine myachine : machines) {
		
		String ip= myachine.getGuestPropertyValue("/VirtualBox/GuestInfo/Net/0/V4/IP");
		maps.VMFree.put(ip, true);
		maps.VMachines.put(ip, myachine);
	}
	//יוצר מספר מכונות חדשות שיהיו מכנות 
	cloneMachine(2);
}
	

	//יצירת מכונה מועתקת
	public  void cloneMachine(int loop) {
			
	IMachine original= machines.get(4);//קבלת המכונה המקורית
	for (int i = 0; i < loop; i++) 
	{
		//יצירת המכונה החדשה
	    String os= original.getOSTypeId();
	    String newName=getNewName();
	    IMachine myClone =  vbox.createMachine(null,newName,null, os, null);
		
	  //הגדרות להעתקה של מכונה החדשה
	  	CloneMode myState=CloneMode.AllStates;
	  	List<CloneOptions> Options=new ArrayList<>();

	  	IProgress clone_progress = original.cloneTo(myClone, CloneMode.MachineState, Options); //הפעלת תהליך תיעתוק
	 	 progressBar(clone_progress); 
	 	
	 	 //שמירת הנתונים	 
	   	myClone.saveSettings();
	 	//הוספה למנהל המכונות
	 	vbox.registerMachine(myClone);
	 	

	 	//הכנסת הIP לרשימות
	 	String ip= myClone.getGuestPropertyValue("/VirtualBox/GuestInfo/Net/<nicId>/V4/IP");
	 	maps.VMFree.put(ip, true);
	 	maps.VMachines.put(ip, myClone);
	 	
	    //טעינת המכונה (הפעלה)
		ISession session = virtualBoxManager.getSessionObject();
		IProgress prog = myClone.launchVMProcess(session, "gui", "");

		}	
	}
	
	//הסרת מכונה נגועה
  	public void DeleteMachine(String ip) {
  		
  		IMachine myDelete = maps.VMachines.get(ip);
  		
  		ISession iSession = virtualBoxManager.getSessionObject();   
        myDelete.lockMachine(iSession, LockType.Shared);
        IConsole iConsole = iSession.getConsole();
        IProgress powerDown_progress= iConsole.powerDown(); 	
        progressBar(powerDown_progress); 
        
  		CleanupMode cleanMode =CleanupMode.DetachAllReturnHardDisksOnly;
	 	List<IMedium> mediu= myDelete.unregister(cleanMode);
	 	IProgress delete_progress = myDelete.deleteConfig(mediu);
	 	 progressBar(delete_progress); 

	 	 
	 	 cloneMachine(1);
	}

	//שם  חדש למכונה 
	static String getNewName() {
		
		String name= "my"+nameVM;
		nameVM++;
		return name;
	}
	
	//פונקציית המתנה עד שיושלם התהליך ומדפיס את האחוזים
  	static boolean progressBar(IProgress p)
    {
        while (!p.getCompleted())
        {
           System.out.println(p.getPercent() + " % ");
        }
        return true;
    }

	
	
	
  	
 

}